
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ORGANIZER
  ADMIN
}

enum OrganizerType {
  NEW
  EXISTING
  MIGRATING
}

enum ApplicationStatus {
  PENDING
  UNDER_RISK_ASSESSMENT
  APPROVED_LIMITED
  APPROVED
  REJECTED
  SUSPENDED
}

enum ApprovalTier {
  TIER_1
  TIER_2
  RESTRICTED
}

enum AuctionStatus {
  ACTIVE
  CLOSED
  WON
}

model User {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String    @db.VarChar(100)
  email         String    @unique @db.VarChar(255)
  password      String    @db.VarChar(255)
  phone         String?   @db.VarChar(20)
  isKycVerified Boolean   @default(false) @map("is_kyc_verified")
  aadhaarNumber String?   @unique @map("aadhaar_number") @db.VarChar(255)
  age           Int?
  address       String?   @map("aadhaar_address") @db.Text
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt     DateTime? @updatedAt @map("updated_at") @db.Timestamp(3)

  role             Role    @default(USER)
  reputation_score Float? @default(50.0) // 0 to 100
  risk_score       Float? @default(50.0) // 0 to 100

  organizer_profile     OrganizerProfile?
  organizer_application OrganizerApplication[]
  admin_actions_made    AdminActionLog[]       @relation("AdminActionsMade")
  escrow_transactions   EscrowTransaction[]
  payouts_won           PayoutQueue[]
  join_requests         JoinRequest[]
  auctions_created      AuctionRequest[]      @relation("AuctionCreator")
  auctions_won          AuctionRequest[]      @relation("AuctionWinner")
  auction_bids          AuctionBid[]          @relation("AuctionBidder")

  @@map("users")
}

model OrganizerProfile {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id String @unique @db.Uuid
  user    User   @relation(fields: [user_id], references: [id])

  license_info            Json?
  gst_info                Json?
  experience_years        Int?              @default(0)
  approval_status         ApplicationStatus @default(PENDING)
  security_deposit_status String?           @db.VarChar(50) // PENDING, PAID, LOCKED
  escrow_enabled          Boolean           @default(false)

  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt

  organizations Organization[]

  @@map("organizer_profiles")
}

model OrganizerApplication {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id String @db.Uuid
  user    User   @relation(fields: [user_id], references: [id])

  type   OrganizerType
  status ApplicationStatus @default(PENDING)

  // Registration data
  company_name         String?   @db.VarChar(255)
  legal_structure      String?   @db.VarChar(100)
  gst_number           String?   @db.VarChar(50)
  business_reg_number  String?   @db.VarChar(100)
  chit_license_number  String?   @db.VarChar(100)
  license_issuing_auth String?   @db.VarChar(255)
  license_valid_till   DateTime?
  years_of_operation   Int?      @default(0)

  office_address String? @db.Text
  city           String? @db.VarChar(100)
  state          String? @db.VarChar(100)
  pincode        String? @db.VarChar(20)

  bank_account_name     String?  @db.VarChar(255)
  bank_name             String?  @db.VarChar(255)
  ifsc_code             String?  @db.VarChar(20)
  escrow_agreed         Boolean? @default(false)
  security_deposit_paid Boolean? @default(false)

  proposed_chit_size       Decimal? @db.Decimal(12, 2)
  proposed_duration_months Int?
  target_area              String?  @db.VarChar(255)
  capital_proof_url        String?  @db.VarChar(255)

  // Migrating specific
  existing_group_count Int?
  total_active_members Int?
  past_3_yr_turnover   Decimal? @db.Decimal(15, 2)
  ledger_upload_url    String?  @db.VarChar(255)

  personal_info     Json?
  professional_info Json?
  income_info       Json?
  purpose_info      Json?


  application_risk_score Float?
  risk_profile Json?

  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt

  @@map("organizer_applications")
}

model Organization {
  id                   String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organizer_profile_id String           @db.Uuid
  organizer_profile    OrganizerProfile @relation(fields: [organizer_profile_id], references: [id])

  name           String  @db.VarChar(255)
  license_number String? @db.VarChar(100)
  gst_number     String? @db.VarChar(50)

  city     String @db.VarChar(100)
  state    String @db.VarChar(100)
  pincode  String @db.VarChar(20)
  geo_lat  Float?
  geo_long Float?

  is_verified      Boolean      @default(false)
  risk_rating      Float?       @default(50.0) // 0-100 risk score
  trust_tier       ApprovalTier @default(RESTRICTED)
  reputation_score Float?       @default(50.0)
  default_rate     Float?       @default(0.0) // %

  total_groups_managed    Int     @default(0)
  migration_priority_flag Boolean @default(false)

  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt

  chit_groups    ChitGroup[]
  actions_logged AdminActionLog[]

  @@map("organizations")
}

model ChitGroup {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  organization_id String       @db.Uuid
  organization    Organization @relation(fields: [organization_id], references: [id])

  name            String  @db.VarChar(255)
  chit_value      Decimal @db.Decimal(12, 2)
  duration_months Int
  member_capacity Int
  current_members Int     @default(0)
  status          String  @default("OPEN") // OPEN, IN_PROGRESS, COMPLETED

  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt

  rules         ChitGroupRule?
  members       ChitGroupMember[]
  applications  ChitGroupApplication[]
  join_requests JoinRequest[]
  announcements Announcement[]
  notifications MemberNotification[]
  auctions      AuctionRequest[]

  escrow_account EscrowAccount?
  payouts        PayoutQueue[]

  @@map("chit_groups")
}

model JoinRequest {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  group_id String @db.Uuid
  user_id  String @db.Uuid
  status   String @default("pending") // pending, approved, rejected

  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt

  group ChitGroup @relation(fields: [group_id], references: [id])
  user  User      @relation(fields: [user_id], references: [id])

  @@map("join_requests")
}
model ChitGroupApplication {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chit_group_id String    @db.Uuid
  user_id       String    @db.Uuid
  organizer_id  String    @db.Uuid
  status        String    @default("PENDING")
  applied_at    DateTime? @default(now()) @db.Timestamp(6)
  reviewed_at   DateTime? @db.Timestamp(6)
  updated_at    DateTime? @updatedAt

  chit_group ChitGroup @relation(fields: [chit_group_id], references: [id])

  @@unique([chit_group_id, user_id])
  @@map("chit_group_applications")
}

model ChitGroupRule {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chit_group_id String    @unique @db.Uuid
  chit_group    ChitGroup @relation(fields: [chit_group_id], references: [id])

  monthly_amount     Decimal? @db.Decimal(12, 2)
  duration_months    Int?
  late_penalty_pct   Float?   @default(2.0) // penalty % for late payment
  commission_pct     Float?   @default(5.0) // organizer commission %
  min_bid_pct        Float?   @default(5.0) // minimum bid percentage
  max_bid_pct        Float?   @default(40.0) // maximum bid percentage
  bidding_day        Int?     @default(1) // day of month for bidding
  payment_due_day    Int?     @default(5) // day of month payment is due
  grace_period_days  Int?     @default(5) // grace period before penalty

  custom_rules Json? // any additional rules as JSON

  created_at DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt

  @@map("chit_group_rules")
}

model ChitGroupMember {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chit_group_id String    @db.Uuid
  chit_group    ChitGroup @relation(fields: [chit_group_id], references: [id])
  user_id       String    @db.Uuid

  name   String  @db.VarChar(100)
  email  String  @db.VarChar(255)
  phone  String? @db.VarChar(20)
  status String  @default("ACTIVE") // ACTIVE, REMOVED, LEFT

  joined_at  DateTime? @default(now()) @db.Timestamp(6)
  updated_at DateTime? @updatedAt

  @@unique([chit_group_id, user_id])
  @@map("chit_group_members")
}

model Announcement {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chit_group_id String    @db.Uuid
  chit_group    ChitGroup @relation(fields: [chit_group_id], references: [id])

  title   String @db.VarChar(255)
  message String @db.Text
  type    String @default("GENERAL") // GENERAL, URGENT, BIDDING, PAYMENT

  created_at DateTime? @default(now()) @db.Timestamp(6)

  @@map("announcements")
}

model MemberNotification {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chit_group_id String    @db.Uuid
  chit_group    ChitGroup @relation(fields: [chit_group_id], references: [id])

  user_id    String? @db.Uuid // null = broadcast to all members
  title      String  @db.VarChar(255)
  message    String  @db.Text
  type       String  @default("DUE_REMINDER") // DUE_REMINDER, BIDDING_ALERT, PENALTY_WARNING, CUSTOM
  is_read    Boolean @default(false)

  created_at DateTime? @default(now()) @db.Timestamp(6)

  @@map("member_notifications")
}

model AdminActionLog {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  admin_id String @db.Uuid
  admin    User   @relation(fields: [admin_id], references: [id], name: "AdminActionsMade")

  action_type     String        @db.VarChar(50) // APPROVE, REJECT, SUSPEND, etc.
  organization_id String?       @db.Uuid
  organization    Organization? @relation(fields: [organization_id], references: [id])

  details String? @db.Text

  created_at DateTime? @default(now()) @db.Timestamp(6)

  @@map("admin_actions_log")
}

model EscrowAccount {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  chit_group_id   String   @unique @db.Uuid
  chit_group      ChitGroup @relation(fields: [chit_group_id], references: [id])
  total_collected Decimal  @default(0.00) @db.Decimal(15, 2)
  total_released  Decimal  @default(0.00) @db.Decimal(15, 2)
  locked_amount   Decimal  @default(0.00) @db.Decimal(15, 2)
  status          String   @default("ACTIVE") // ACTIVE, COMPLETED, FROZEN
  created_at      DateTime @default(now()) @db.Timestamp(6)
  updated_at      DateTime? @updatedAt

  transactions  EscrowTransaction[]
  payouts       PayoutQueue[]
  
  @@map("escrow_accounts")
}

model EscrowTransaction {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  escrow_account_id String   @db.Uuid
  escrow_account    EscrowAccount @relation(fields: [escrow_account_id], references: [id])
  user_id           String   @db.Uuid
  user              User     @relation(fields: [user_id], references: [id])
  type              String   @db.VarChar(50) // CONTRIBUTION, PAYOUT, REFUND
  amount            Decimal  @db.Decimal(15, 2)
  status            String   @default("PENDING") @db.VarChar(50) // PENDING, CONFIRMED, FAILED
  payment_gateway_txn_id String? @db.VarChar(255)
  blockchain_hash   String?  @db.VarChar(255)
  created_at        DateTime @default(now()) @db.Timestamp(6)

  @@map("escrow_transactions")
}

model PayoutQueue {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  escrow_account_id String   @db.Uuid
  escrow_account    EscrowAccount @relation(fields: [escrow_account_id], references: [id])
  chit_group_id     String   @db.Uuid
  chit_group        ChitGroup @relation(fields: [chit_group_id], references: [id])
  winner_user_id    String   @db.Uuid
  winner_user       User     @relation(fields: [winner_user_id], references: [id])
  amount            Decimal  @db.Decimal(15, 2)
  status            String   @default("PENDING_RELEASE") @db.VarChar(50) // PENDING_RELEASE, RELEASED, BLOCKED
  risk_flag         Boolean  @default(false)
  created_at        DateTime @default(now()) @db.Timestamp(6)

  @@map("payout_queue")
}

model BlockchainAuditLog {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  event_type      String   @db.VarChar(100) // CONTRIBUTION, PAYOUT
  entity_id       String   @db.Uuid // Transaction ID or Payout ID
  hash            String   @db.VarChar(255)
  timestamp       DateTime @default(now()) @db.Timestamp(6)
  block_number    Int?

  @@map("blockchain_audit_logs")
}

model AuctionRequest {
  id                   String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  group_id             String       @db.Uuid
  group                ChitGroup    @relation(fields: [group_id], references: [id], onDelete: Cascade)
  created_by           String       @db.Uuid
  created_by_user      User         @relation("AuctionCreator", fields: [created_by], references: [id])
  highest_bid          Decimal      @db.Decimal(12, 2)
  winner_id            String?      @db.Uuid
  winner_user          User?        @relation("AuctionWinner", fields: [winner_id], references: [id])
  status               AuctionStatus @default(ACTIVE)
  reason               String?      @db.Text
  round_number         Int?
  winner_declared_at   DateTime?    @db.Timestamp(6)
  winner_payment_due_at DateTime?   @db.Timestamp(6)
  winner_paid_at       DateTime?    @db.Timestamp(6)
  created_at           DateTime?    @default(now()) @db.Timestamp(6)
  updated_at           DateTime?    @updatedAt
  bids                 AuctionBid[]

  @@index([group_id, status])
  @@index([created_by])
  @@map("auction_requests")
}

model AuctionBid {
  id           String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  auction_id   String         @db.Uuid
  auction      AuctionRequest @relation(fields: [auction_id], references: [id], onDelete: Cascade)
  bidder_id    String         @db.Uuid
  bidder       User           @relation("AuctionBidder", fields: [bidder_id], references: [id])
  bid_amount   Decimal        @db.Decimal(12, 2)
  created_at   DateTime?      @default(now()) @db.Timestamp(6)

  @@index([auction_id, created_at])
  @@index([bidder_id])
  @@map("auction_bids")
}
